---
title: "Final Project"
author: "Sienna Wang, Hengyi Xing"
date: "2024-11-03"
format: 
  pdf:
    include-in-header: 
       text: |
         \usepackage{fvextra}
         \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
include-before-body:
  text: |
    \RecustomVerbatimEnvironment{verbatim}{Verbatim}{
      showspaces = false,
      showtabs = false,
      breaksymbolleft={},
      breaklines
    }
output:
  echo: false
  eval: false
---

```{python}
import pandas as pd
import altair as alt
import numpy as np
```

# Plot the relationship between the number of attacks and average GDP

```{python}
# Import the GDP data
path = "/Users/wangshiying/Documents/71_Python_Programming_II/DAP2-FINAL/data/"
file_name = "GDP.csv"
df_gdp = pd.read_csv(path + file_name)
df_gdp = df_gdp[df_gdp["Series Name"] == "GDP (current US$)"]

# Convert the GDP values to numeric type
gdp_columns = [col for col in df_gdp.columns if "YR" in col]
for col in gdp_columns:
    df_gdp[col] = pd.to_numeric(df_gdp[col], errors="coerce")

# Calculate the average GDP
df_gdp["average_gdp"] = df_gdp[gdp_columns].mean(axis=1)
```

```{python}
# Import the GTD dataframe
file_name = "globalterrorismdb.csv"
df_gtd = pd.read_csv(path + file_name)

# Filter the dataset to focus on the 21st centry
gtd_clean = df_gtd[["iyear", "country", "country_txt", "nkill", "nwound", "motive"]]
gtd_clean = gtd_clean[gtd_clean["iyear"] > 1999]

# Calculate the amount of attack
gtd_count = gtd_clean.groupby("country_txt").agg(
  attack_count = ("country_txt", "size")
).reset_index()
```

```{python}
# Match the names
df_gdp["Country Name"] = df_gdp["Country Name"].replace({
  "Bahamas, The": "Bahamas",
  "Bosnia and Herzegovina": "Bosnia-Herzegovina",
  "Czechia": "Czech Republic",
  "Congo, Dem. Rep.": "Democratic Republic of the Congo",
  "Timor-Leste": "East Timor",
  "Egypt, Arab Rep.": "Egypt",
  "Gambia, The": "Gambia",
  "Hong Kong SAR, China": "Hong Kong",
  "Iran, Islamic Rep.": "Iran",
  "Cote d'Ivoire": "Ivory Coast",
  "Kyrgyz Republic": "Kyrgyzstan",
  "Lao PDR": "Laos",
  "North Macedonia": "Macedonia",
  "Congo, Rep.": "Republic of the Congo",
  "Russian Federation": "Russia",
  "Korea, Rep.": "South Korea",
  "Eswatini": "Swaziland",
  "Syrian Arab Republic": "Syria",
  "Turkiye": "Turkey",
  "Venezuela, RB": "Venezuela",
  "Viet Nam": "Vietnam",
  "West Bank and Gaza": "West Bank and Gaza Strip",
  "Yemen, Rep.": "Yemen"
  })

# Clean countries that no longer exists
gtd_count = gtd_count[gtd_count["country_txt"] != "International"]

# For Yugoslavia
serbia_montenegro_count = gtd_count.loc[gtd_count["country_txt"] == "Serbia-Montenegro", "attack_count"].values[0]
yugoslavia_count = gtd_count.loc[gtd_count["country_txt"] == "Yugoslavia", "attack_count"].values[0]

serbia_count = (serbia_montenegro_count / 2) + (yugoslavia_count / 2)
montenegro_count = (serbia_montenegro_count / 2) + (yugoslavia_count / 2)
gtd_count.loc[gtd_count["country_txt"] == "Serbia", "attack_count"] += serbia_count
gtd_count.loc[gtd_count["country_txt"] == "Montenegro", "attack_count"] += montenegro_count

gtd_count = gtd_count[gtd_count["country_txt"] != "Serbia-Montenegro"]
gtd_count = gtd_count[gtd_count["country_txt"] != "Yugoslavia"]

# For Taiwan
taiwan_count = gtd_count.loc[gtd_count["country_txt"] == "Taiwan", "attack_count"].values[0]
gtd_count.loc[gtd_count["country_txt"] == "China", "attack_count"] += taiwan_count
gtd_count = gtd_count[gtd_count["country_txt"] != "Taiwan"]

# Merge the dataframes
gtd_gdp = gtd_count.merge(df_gdp[["Country Name", "average_gdp"]], left_on="country_txt", right_on="Country Name", how="left")
```

```{python}
# Use log to scale the data
gtd_gdp["log_average_gdp"] = np.log(gtd_gdp["average_gdp"])
gtd_gdp["log_attack_count"] = np.log(gtd_gdp["attack_count"])

# Make the plot
scatter_plot = alt.Chart(gtd_gdp).mark_circle(size=60, opacity=0.6, color="steelblue").encode(
    alt.X("log_average_gdp", title="Log Average GDP ($)", scale=alt.Scale(zero=False)),
    alt.Y("log_attack_count", title="Log Number of Attacks", scale=alt.Scale(zero=True))
).properties(
    width=500,
    height=300,
    title=alt.TitleParams(
        text="Average GDP vs Number of Terrorist Attacks (2000 - 2020)",
        fontSize=12,
        anchor="start",
        color="black"
    )
)

trend_line = scatter_plot.transform_regression("log_average_gdp", "log_attack_count").mark_line(color="red")

scatter_plot + trend_line
```